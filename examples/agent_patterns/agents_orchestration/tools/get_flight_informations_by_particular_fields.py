import asyncio
import requests
import json
import os
from agents import (
    Agent,
    ModelSettings,
    Runner,
    function_tool,
    trace,
)
from call_mcp_tool import call_mcp_tool
@function_tool(
    name_override="get_flight_information",
    description_override="Fetch FULL detailed flight information using flexible search criteria",
)
def get_flight_information(
    p_flightid: str | None = None,
    p_airline_code: str | None = None,
    p_flightno: str | None = None,
    p_route: str | None = None,
    p_flightdate: str | None = None,
    p_dept: str | None = None,
    p_arrival: str | None = None,
    p_actype: str | None = None,
    p_flighttype: str | None = None,
    p_eobt: str | None = None,
    p_eibt: str | None = None,
    p_eldt: str | None = None,
    p_status: str | None = None,
) -> str:
    response = call_mcp_tool(
        "get_flight_informations_by_particular_fields",
        {
            "p_flightid": p_flightid,
            "p_airline_code": p_airline_code,
            "p_flightno": p_flightno,
            "p_route": p_route,
            "p_flightdate": p_flightdate,
            "p_dept": p_dept,
            "p_arrival": p_arrival,
            "p_actype": p_actype,
            "p_flighttype": p_flighttype,
            "p_eobt": p_eobt,
            "p_eibt": p_eibt,
            "p_eldt": p_eldt,
            "p_status": p_status,
        },
    )

    flights = json.loads(response["result"]["content"][0]["text"])

    if not flights:
        return "âŒ KhÃ´ng tÃ¬m tháº¥y chuyáº¿n bay phÃ¹ há»£p vá»›i tiÃªu chÃ­ tra cá»©u."

    status_map = {
        "OPN": "ğŸŸ¢ Open â€“ Äang lÃ m thá»§ tá»¥c / boarding",
        "CLS": "ğŸŸ¡ Close â€“ ÄÃ£ Ä‘Ã³ng chuyáº¿n / Ä‘Ã£ khá»Ÿi hÃ nh",
        "CNX": "ğŸ”´ Canceled â€“ Há»§y chuyáº¿n",
        "XXX": "âš« Deleted â€“ ÄÃ£ xÃ³a khá»i há»‡ thá»‘ng",
    }

    results = []
    MAX_FLIGHTS = 5
    flights = flights[:MAX_FLIGHTS]
    for f in flights:
        results.append(
            "âœˆï¸ THÃ”NG TIN CHUYáº¾N BAY (CHI TIáº¾T)\n"
            "--------------------------------\n"
            f"ğŸ†” Flight ID: {f.get('Unique identifier generated by the airline system for this flight record')}\n"
            f"ğŸ·ï¸ HÃ£ng bay: {f.get('The airline code is the two-letter IATA prefix of the flight number')}\n"
            f"âœˆï¸ Sá»‘ hiá»‡u chuyáº¿n bay: {f.get('The full flight number including airline prefix')}\n"
            f"ğŸ—ºï¸ Cháº·ng bay: {f.get('The flight route represented as Origin-Destination')}\n"
            f"ğŸ“ SÃ¢n bay Ä‘i: {f.get('The departure airport code in IATA format (3 letters)')}\n"
            f"ğŸ“ SÃ¢n bay Ä‘áº¿n: {f.get('The arrival airport code in IATA format (3 letters)')}\n"
            f"ğŸ  Base station: {f.get('Base station or operating airport for the flight')}\n"
            f"ğŸ“… NgÃ y bay: {f.get('The scheduled date of the flight in yyyy-MM-dd format')}\n\n"

            "â° GIá»œ KHAI THÃC\n"
            f"- EIBT (ETA): {f.get('Estimated In-Block Time (EIBT) indicates the estimated time the aircraft will arrive at the gate at the destination')}\n"
            f"- ELDT (Giá» dá»± kiáº¿n háº¡ cÃ¡nh): {f.get('Estimated Landing Date and Time (ELDT) is the predicted arrival time at the destination gate')}\n"
            f"- ALDT (Giá» háº¡ cÃ¡nh thá»±c táº¿): {f.get('Actual Landing Date and Time (ALDT) represents the real timestamp when the aircraft landed')}\n"
            f"- AIBT (Giá» vÃ o bÃ£i): {f.get('Actual In-Block Time (AIBT) represents when the aircraft arrives at its parking position at the destination gate')}\n\n"

            "ğŸ“Š TRáº NG THÃI CHUYáº¾N BAY\n"
            f"- Tráº¡ng thÃ¡i: {status_map.get(f.get('Current flight status'), f.get('Current flight status'))}\n"
        )
    return "\n\n".join(results)